import json
import pytest

from src.choropleth.distance_choropleth import create_choropleth

coords = [
    ["Aarburg, Alter Friedhof",47.326206,7.9005933,"14:30"],
    ["Aarburg, Höhe",47.329163,7.9043303,"14:28"],
    ["Aarburg, Kloosmatte",47.33682,7.9078603,"14:26"],
    ["Aarburg, Längacker",47.333096,7.9062257,"14:27"],
    ["Aarburg, Stadtgarten",47.320015,7.8994164,"14:31"],
    ["Aarburg, Städtli",47.321762,7.898985,"14:31"],
    ["Aarburg-Oftringen",47.32027,7.90822,"14:35"],
    ["Aarburg-Oftringen",47.32027,7.90822,None],
    ["Aarburg-Oftringen, Bahnhof",47.32015,7.9078155,"14:37"],
    ["Oftringen, Baslerstrasse",47.314064,7.918218,"14:40"],
    ["Oftringen, Bühnenberg-Sonnmatt",47.298832,7.9446645,"14:23"],
    ["Oftringen, Döbeligut",47.296883,7.944988,"14:23"],
    ["Oftringen, Eggenscheide",47.3169,7.9137535,"14:39"],
    ["Oftringen, Gilam",47.303497,7.93684,"14:26"],
    ["Oftringen, Kreuzplatz",47.31244,7.9206705,"14:42"],
    ["Oftringen, Lerchenfeld",47.30077,7.9334173,"14:39"],
    ["Oftringen, Neuquartier",47.314247,7.9224763,"14:31"],
    ["Oftringen, Oberfeld",47.314785,7.9274077,"14:29"],
    ["Oftringen, Obristhof",47.31622,7.9223504,"14:30"],
    ["Oftringen, Perry-Center",47.311703,7.913511,"14:44"],
    ["Oftringen, Ruhbank",47.29619,7.9365077,"14:38"],
    ["Oftringen, Schulhaus/Kirche",47.311714,7.9297256,"14:28"],
    ["Oftringen, Wirtshüsli",47.303772,7.931414,"14:40"],
    ["Oftringen, alte Strasse",47.308987,7.9111843,"14:44"],
    ["Oftringen,Kallernhag/Center A1",47.308346,7.926761,"14:41"],
    ["Rothrist",47.306458,7.8793926,"15:00"],
    ["Rothrist, Bahnhof",47.30615,7.8784947,"14:58"],
    ["Rothrist, Breitenpark",47.306232,7.8865795,"14:53"],
    ["Rothrist, Brunnhalde",47.300182,7.8774166,"14:44"],
    ["Rothrist, Flecken",47.3061,7.903818,"14:46"],
    ["Rothrist, Gemeindehaus",47.305264,7.8919783,"14:51"],
    ["Rothrist, Gländ",47.295326,7.903683,"14:48"],
    ["Rothrist, Grüebli",47.30269,7.877264,"14:45"],
    ["Rothrist, Hungerzelg",47.29613,7.8582644,"14:39"],
    ["Rothrist, Neue Industriestr.",47.30013,7.8667088,"14:40"],
    ["Rothrist, Oberwil",47.298214,7.870221,"14:43"],
    ["Rothrist, Rössli",47.30541,7.899452,"14:50"],
    ["Rothrist, Schwimmbad",47.300407,7.9010243,"14:49"],
    ["Rothrist, Sennhof-Dörfli",47.305588,7.888969,"14:52"],
    ["Rothrist, Weier",47.2986,7.8738503,"14:43"],
    ["Strengelbach, Bifang",47.280994,7.932672,"14:40"],
    ["Strengelbach, Burgherr",47.275646,7.932079,"14:06"],
    ["Strengelbach, Gemeindehaus",47.27826,7.929851,"14:39"],
    ["Strengelbach, Hard",47.286285,7.929977,"14:12"],
    ["Strengelbach, Hardmattenweg",47.282227,7.926375,"14:09"],
    ["Strengelbach, Kath. Kirche",47.2806,7.9303093,"14:08"],
    ["Strengelbach, Kreuzplatz",47.278736,7.9286385,"14:41"],
    ["Strengelbach, Schleipfen",47.277588,7.9211016,"14:42"],
    ["Strengelbach, Schürliweg",47.2857,7.932681,"14:13"],
    ["Strengelbach, Seniorenzentrum",47.28035,7.927749,"14:09"],
    ["Strengelbach, Sägetstrasse",47.28608,7.925683,"14:11"],
    ["Zofingen",47.28805,7.9431195,"14:32"],
    ["Zofingen",47.28805,7.9431195,None],
    ["Zofingen, Ackerstrasse",47.297638,7.950629,"14:17"],
    ["Zofingen, Altachen",47.278633,7.947036,"14:09"],
    ["Zofingen, Bahnhof",47.28714,7.9441075,"14:35"],
    ["Zofingen, Bahnhof",47.28714,7.9441075,"14:36"],
    ["Zofingen, Bahnhofplatz",47.28817,7.9436493,"14:34"],
    ["Zofingen, Bahnhofunterführung",47.28851,7.9424095,"14:30"],
    ["Zofingen, Bergli Friedhof",47.280666,7.9580135,"14:29"],
    ["Zofingen, Bethge",47.298588,7.9636726,"14:15"],
    ["Zofingen, Bifangstrasse",47.291405,7.9444127,"14:21"],
    ["Zofingen, Bleiche",47.293797,7.9331927,"07:59"],
    ["Zofingen, Eisengrube",47.276333,7.9429846,"14:08"],
    ["Zofingen, Falkeisenmatte",47.284523,7.940155,"14:38"],
    ["Zofingen, Frikartstrasse",47.282665,7.945967,"14:11"],
    ["Zofingen, Haldenweg",47.278496,7.957915,"14:26"],
    ["Zofingen, Heitere Hirschpark",47.282635,7.958256,"14:31"],
    ["Zofingen, Heitereplatz",47.28516,7.9569535,"14:32"],
    ["Zofingen, Henzmannstrasse",47.287643,7.939445,"14:37"],
    ["Zofingen, Industrie Brühl",47.294926,7.9301295,"07:59"],
    ["Zofingen, JHCO",47.297325,7.957672,"14:16"],
    ["Zofingen, Mühlethalstrasse",47.294785,7.9461107,"14:22"],
    ["Zofingen, Mühlewiese",47.2825,7.937271,"14:39"],
    ["Zofingen, Oberer Stadteingang",47.286053,7.9472785,"14:33"],
    ["Zofingen, Riedtalstrasse",47.278435,7.951779,"14:25"],
    ["Zofingen, Römerbad",47.282223,7.9487157,"14:24"],
    ["Zofingen, Schwimmbad",47.27886,7.942652,"14:07"],
    ["Zofingen, Spital",47.295475,7.947674,"14:18"],
    ["Zofingen, Spitalgasse",47.291695,7.942697,"14:37"],
    ["Zofingen, Tagblatt",47.28702,7.9366064,"14:14"],
    ["Zofingen, Untere Brühlstrasse",47.28993,7.937523,"08:00"],
    ["Zofingen, Wässermattenweg",47.291878,7.9345493,"08:00"],
]

geojson = {
    "type":"FeatureCollection",
    "features":[
        {
            "type":"Feature",
            "id":"Aarburg",
            "properties":{},
            "geometry":{
                "type":"Polygon",
                "coordinates":[[[7.915863480870074,47.33660559422593],[7.91822219733918,47.33539153425738],[7.9177232380861,47.33194838057609],[7.9269313043020295,47.32932123441464],[7.926160185456361,47.32770912199739],[7.9170881990367254,47.32701253021215],[7.916679959647842,47.32303200572511],[7.91123676779606,47.32072330152263],[7.9103749290861956,47.31489183314911],[7.91500164216021,47.31226468698766],[7.909558450308428,47.30796572054165],[7.892185596314826,47.31622530885227],[7.89858134674067,47.320404859563666],[7.895859750814779,47.32315142145972],[7.8968123093888405,47.32764941413008],[7.90230086117272,47.33517260541059],[7.9103749290861956,47.341740470814216],[7.9103749290861956,47.33973030594826],[7.915863480870074,47.33660559422593]]]
            }
        },
        {
            "type":"Feature",
            "id":"Oftringen",
            "properties":{},
            "geometry":{
                "type":"Polygon",
                "coordinates":[[[7.931240497851356,47.33310273267733],[7.947887592931387,47.33264497236132],[7.948930871369645,47.32952026063899],[7.947252553882013,47.32504217059107],[7.948341192252369,47.31769810291247],[7.96371820923365,47.32070339890019],[7.966802684616326,47.316066087872784],[7.963173890048472,47.315150567240764],[7.9689799613570385,47.309995788030044],[7.976373630289041,47.30782640218461],[7.969297480881726,47.30507984028855],[7.96870780176445,47.301835712831604],[7.962584210931196,47.301517270872644],[7.96371820923365,47.299049345690676],[7.957095659147317,47.298273143415706],[7.95328542485107,47.29994496370026],[7.9405846438635805,47.292780019623585],[7.931920896832829,47.29761635687534],[7.928745701585957,47.298253240793265],[7.918176837407081,47.306293900257096],[7.909558450308428,47.30796572054165],[7.91500164216021,47.31226468698766],[7.9103749290861956,47.31489183314911],[7.91123676779606,47.32072330152263],[7.916679959647842,47.32303200572511],[7.9170881990367254,47.32701253021215],[7.926160185456361,47.32770912199739],[7.9269313043020295,47.32932123441464],[7.9177232380861,47.33194838057609],[7.91822219733918,47.33539153425738],[7.919265475777438,47.33397844806448],[7.931240497851356,47.33310273267733]]]
            }
        },
        {
            "type":"Feature",
            "id":"Rothrist",
            "properties":{},
            "geometry":{
                "type":"Polygon",
                "coordinates":[[[7.909558450308428,47.30796572054165],[7.918176837407081,47.306293900257096],[7.928745701585957,47.298253240793265],[7.922123151499623,47.29566589987669],[7.914638762703424,47.29662122575358],[7.906201815333163,47.295765412988864],[7.894181433327146,47.28718738271929],[7.889781519913623,47.28505780211872],[7.878940496142159,47.28251026644701],[7.87644569987676,47.280301075356704],[7.868371631963285,47.285217023098205],[7.8642892380744485,47.28432140508862],[7.858936766086864,47.287625240412865],[7.850681258444996,47.29017277608457],[7.862565560654718,47.307468154980775],[7.873950903611361,47.311707413559475],[7.880573453697694,47.31140887422295],[7.887468163376616,47.31210546600818],[7.892185596314826,47.31622530885227],[7.909558450308428,47.30796572054165]]]
            }
        },
        {
            "type":"Feature",
            "id":"Strengelbach",
            "properties":{},
            "geometry":{
                "type":"Polygon",
                "coordinates":[[[7.940448564067286,47.27490746467676],[7.939405285629028,47.27297691030054],[7.9250261871539065,47.26579206360143],[7.917859317882394,47.26587167409117],[7.9160902805305655,47.26772261797765],[7.918539716863867,47.27104635592433],[7.912733645555301,47.27484775680946],[7.913459404468871,47.276718603318365],[7.907880132820796,47.27725597412412],[7.90602037560477,47.279465165214425],[7.910692448610883,47.29025238657431],[7.906201815333163,47.295765412988864],[7.914638762703424,47.29662122575358],[7.922123151499623,47.29566589987669],[7.928745701585957,47.298253240793265],[7.930696178666178,47.29582512085617],[7.936139370517959,47.28119669336629],[7.940448564067286,47.27490746467676]]]
            }
        },
        {
            "type":"Feature",
            "id":"Zofingen",
            "properties":{},
            "geometry":{
                "type":"Polygon",
                "coordinates":[[[7.985944575961756,47.291267420318505],[7.978868426554441,47.28501799687385],[7.988076492770371,47.28157484319256],[7.995470161702373,47.28400296312965],[7.999688635387503,47.28318695560981],[7.9976927983751835,47.279723899306084],[7.9952887219739806,47.281554940570125],[7.9868517746037195,47.27604191415557],[7.973470594634758,47.274429801738314],[7.971021158301456,47.27612152464531],[7.956097740641157,47.276857921675415],[7.95079062858567,47.27490746467676],[7.948250472388172,47.27628074562479],[7.940448564067286,47.27490746467676],[7.936139370517959,47.28119669336629],[7.930696178666178,47.29582512085617],[7.928745701585957,47.298253240793265],[7.931920896832829,47.29761635687534],[7.9405846438635805,47.292780019623585],[7.95328542485107,47.29994496370026],[7.957095659147317,47.298273143415706],[7.96371820923365,47.299049345690676],[7.962584210931196,47.301517270872644],[7.96870780176445,47.301835712831604],[7.969297480881726,47.30507984028855],[7.976373630289041,47.30782640218461],[7.982950820443277,47.30808513627626],[7.9845384180667125,47.30189542069891],[7.989618730461709,47.29652171264141],[7.985944575961756,47.291267420318505]]]
            }
        }
    ]
}

def test_rothrist_region():
    def parse_time(time_str):
        if time_str is None:
            return None
        hh, mm = map(int, time_str.split(":"))
        return hh * 60 + mm

    def print_time(minutes):
        hh = minutes // 60
        mm = minutes % 60
        return "{:02d}:{:02d}".format(hh, mm)
    
    def check_choropleth_value(choropleth, id):
        expected = max(
            parse_time(t) for p,_,_,t in coords 
            if p.startswith(id) and t is not None
        )
        assert choropleth[id] == expected, f"{print_time(choropleth[id])} (actual) == {print_time(expected)} (expected)"
    
    coord_to_departure = {
        (lon, lat): parse_time(dep)
        for _, lat, lon, dep in coords
    }

    for feature in geojson["features"]:
        feature["properties"]["id"] = feature["id"]

    choropleth = create_choropleth(coord_to_departure, geojson)
    
        
    print({
        id: print_time(val) for id, val in choropleth.items() if val is not None
    })
    
    # currently doesn't pass because "Oftringen, PerryCenter" is in Aarburg Polygon 
    check_choropleth_value(choropleth, "Aarburg")
    check_choropleth_value(choropleth, "Oftringen")
    check_choropleth_value(choropleth, "Rothrist")
    check_choropleth_value(choropleth, "Strengelbach")
    check_choropleth_value(choropleth, "Zofingen")

    assert False

